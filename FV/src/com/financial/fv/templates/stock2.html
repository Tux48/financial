<!DOCTYPE html>
<html style="height: 100%">
	<head>
		<meta charset="UTF-8">
		<title>Stock</title>
	</head>
	
	<script src="{{ url_for('static', filename='echarts.js') }}"></script>
	<script src="{{ url_for('static', filename='jquery-3.4.0.js') }}"></script>	
       	
    <body style="height: 100%; margin: 0">
    	<br>
    	<div style="text-align:center;">
	    	MA1: 
	    	<input id="ma1" type="text" value="5" size = "2" />
	    	MA2: 
	    	<input id="ma2" type="text" value="10" size = "2" />
	    	MA3: 
	    	<input id="ma3" type="text" value="20" size = "2" />
	    	MA4: 
	    	<input id="ma4" type="text" value="30" size = "2" />
	    	<button onclick="draw()">确定</button>
    	</div>
    	<br>
		<div id="container" style="height: 100%">
		</div>
	</body>
       	
	<script type="text/javascript">
       	$.ajaxSetup({  
	    	async : false  
	    });  	// 将请求设置为同步
	       	
     	// 数据意义：开盘(open)，收盘(close)，最低(lowest)，最高(highest)， 成交量(volume)
   		var data;	// 股票或指数数据
	    var dataForBuy;	// 买点数据
	    var dataForDown;	// 连跌点数据
	    
	    var macd;
	    var dif;
	    var dea;
	
	    // 获取指定股票数据
	    $.getJSON( '/index_day/b001/399001.SZ' ).done( function( datas ) {
	    	data = splitData( datas.data )
	    	dataForBuy = datas.buy
	    	dataForDown = datas.down
	    	
	    	macd = datas.macd
	    	dif = datas.dif
	    	dea = datas.dea
	    });
	    
	   	var dom = document.getElementById("container");
       	var myChart = echarts.init(dom);
       	var app = {};
       	option = null;
       	var upColor = '#ec0000';
       	var downColor = '#00da3c';
       	
       	function splitData(rawData) {
       		var categoryData = [];
       		var values = [];
       		var volumes = [];
       		
       		for (var i = 0; i < rawData.length; i++) {
       		    categoryData.push(rawData[i].splice(0, 1)[0]);
       		    values.push(rawData[i]);
       		    volumes.push([i, rawData[i][4], rawData[i][0] > rawData[i][1] ? 1 : -1]);
       		}
    
       		return {
       		    categoryData: categoryData,
       		    values: values,
       		    volumes: volumes
       		};
      	}

       	function calculateMA(dayCount, data) {
       		var result = [];
       		for (var i = 0, len = data.values.length; i < len; i++) {
       		    if (i < dayCount) {
       		        result.push('-');
       		        continue;
       		    }
       		    
       		    var sum = 0;
       		    for (var j = 0; j < dayCount; j++) {
       		        sum += data.values[i - j][1];
       		    }
       		    result.push(+(sum / dayCount).toFixed(3));
       		}
       		
       		return result;
       	}
       
       	function draw( ma1, ma2, ma3, ma4 ) {
       		
       		var ma1 = document.getElementById("ma1").value;
       		var ma2 = document.getElementById("ma2").value;
       		var ma3 = document.getElementById("ma3").value;
       		var ma4 = document.getElementById("ma4").value;
       		
       		var title = new Array( 5 );
       		title[ 0 ] = "K线";
       		title[ 1 ] = "MA" + ma1;
       		title[ 2 ] = "MA" + ma2;
       		title[ 3 ] = "MA" + ma3;
       		title[ 4 ] = "MA" + ma4;
       		
	       	option = {
	       		backgroundColor: '#fff',
	       		animation: false,
	       		title: {
	       		    text: '000001.SZ',
	       		    left: 100
	       		},
	       		legend: {
	       		    left: 'center',
	       		 	data: title
	       		},
	       		tooltip: {
	       		    trigger: 'axis',
	       		    axisPointer: {
	       		        type: 'cross'
	       		    },
	       		    backgroundColor: 'rgba(245, 245, 245, 0.8)',
	       		    borderWidth: 1,
	       		    borderColor: '#ccc',
	       		    padding: 10,
	       		    textStyle: {
	       		        color: '#000'
	       		    },
	       		    position: function (pos, params, el, elRect, size) {
	       		        var obj = {top: 10};
	       		        obj[['left', 'right'][+(pos[0] < size.viewSize[0] / 2)]] = 30;
	       		
	       		        return obj;
	       		    }
	       		},
	       		axisPointer: {
	       		    link: {xAxisIndex: 'all'},
	       		    label: {
	       		        backgroundColor: '#777'
	       		    }
	       		},
	       		toolbox: {
	       		    feature: {
		       		    dataZoom: {
		       		        yAxisIndex: false
		       		    },
		       		    brush: {
		       		        type: ['lineX', 'clear']
		       		    }
	       		    }
	       		},
	       		brush: {
	       		    xAxisIndex: 'all',
	       		    brushLink: 'all',
	       		    outOfBrush: {
	       		    	colorAlpha: 0.1
	       		    }
	       		},
	       		visualMap: {
	       		    show: false,
	       		    seriesIndex: 5,
	       		    dimension: 2,
	       		    pieces: [ {
	       		    	value: 1,
	       		        color: downColor
	       		    },
	       		    {
	       		        value: -1,
	       		        color: upColor
	       		    }]
	       		},
	       		grid: [ {
	       			left: '10%',
	       		    right: '8%',
	       		    height: '50%'
	       		},
	       		{
	       		    left: '10%',
	       		    right: '8%',
	       		    top: '63%',
	       		    height: '16%'
	       		} ],
	       		xAxis: [ {
	       		    type: 'category',
	       		    data: data.categoryData,
	       		    scale: true,
	       		    boundaryGap : false,
	       		    axisLine: {onZero: false},
	       		    splitLine: {show: false},
	       		    splitNumber: 20,
	       		    min: 'dataMin',
	       		    max: 'dataMax',
	       		    axisPointer: {
	       		    	z: 100
	       		    }
	       		},
	       		{
	       			type: 'category',
	       		    gridIndex: 1,
	       		    data: data.categoryData,
	       		    scale: true,
	       		    boundaryGap : false,
	       		    axisLine: {onZero: false},
	       		    axisTick: {show: false},
	       		    splitLine: {show: false},
	       		    axisLabel: {show: false},
	       		    splitNumber: 20,
	       		    min: 'dataMin',
	       		    max: 'dataMax'
	       		},{
	       			type: 'category',
	       		    gridIndex: 1,
	       		    data: data.categoryData,
	       		    scale: true,
	       		    boundaryGap : false,
	       		    axisLine: {onZero: false},
	       		    axisTick: {show: false},
	       		    splitLine: {show: false},
	       		    axisLabel: {show: true},
	       		    splitNumber: 20,
	       		    min: 'dataMin',
	       		    max: 'dataMax'
	           	  } ],
	       		yAxis: [ {
	       		    scale: true,
	       		    splitArea: {
	       		    	show: true
	       		    }
	       		},
	       		{
	       			scale: true,
	       		    gridIndex: 1,
	       		    splitNumber: 2,
	       		    axisLabel: {show: true},
	       		    axisLine: {show: true},
	       		    axisTick: {show: true},
	       		    splitLine: {show: true}
	       		},{
	       			scale: true,
	       		    gridIndex: 2,
	       		    splitNumber: 3,
	       		    axisLabel: {show: true},
	       		    axisLine: {show: true},
	       		    axisTick: {show: true},
	       		    splitLine: {show: true}
	       		} ],
	       		dataZoom: [ {
	       		    	type: 'inside',
	       		    	xAxisIndex: [0, 1],
	       		    	start: 98,
	       		    	end: 100
	       		    },
	       		    {
	       		    	show: true,
	       		        xAxisIndex: [0, 1],
	       		        type: 'slider',
	       		        top: '85%',
	       		        start: 98,
	       		        end: 100,
	       		        handleSize: '150%'
	       		    } ],
	       		    series: [ {
	       		    	name: 'K线',
	       		        type: 'candlestick',
	       		        data: data.values,
	       		        itemStyle: {
	       		         	normal: {
	       		           		color: upColor,
	       		            	color0: downColor,
	       		            	borderColor: null,
	       		            	borderColor0: null
	       		            }
	       		        },
	       		        tooltip: {
	       		         	formatter: function (param) {
	       		           	param = param[0];
	       		            return [
	       		            	'Date: ' + param.name + '<hr size=1 style="margin: 3px 0">',
	       		                'Open: ' + param.data[0] + '<br/>',
	       		                'Close: ' + param.data[1] + '<br/>',
	       		                'Lowest: ' + param.data[2] + '<br/>',
	       		                'Highest: ' + param.data[3] + '<br/>' ].join('');
	       		        	}
	       		        }
	       		    },
	       		    {
	       		    	name: title[ 1 ],
	       		        type: 'line',
	       		        data: calculateMA(ma1, data),
	       		        smooth: true,
	       		        showSymbol: false,
	       		        lineStyle: {
	       		        	normal: {opacity: 0.5}
	       		        }
	       		    },
	       		    {
	       		    	name: title[ 2 ],
	       		        type: 'line',
	       		        data: calculateMA(ma2, data),
	       		        smooth: true,
	       		        showSymbol: false,
	       		        lineStyle: {
	       		        	normal: {opacity: 0.5}
	       		        }
	       		    },
	       		    {
	       		    	name: title[ 3 ],
	       		        type: 'line',
	       		        data: calculateMA(ma3, data),
	       		        smooth: true,
	       		        showSymbol: false,
	       		        lineStyle: {
	       		        	normal: {opacity: 0.5}
	       		        }
	       		    },
	       		    {
	       		    	name: title[ 4 ],
	       		        type: 'line',
	       		        data: calculateMA(ma4, data),
	       		        smooth: true,
	       		        showSymbol: false,
	       		        lineStyle: {
	       		        	normal: {opacity: 0.5}
	       		        }
	       		    },
	       		    {
	       		    	name: 'Volume',
	       		        type: 'bar',
	       		        xAxisIndex: 1,
	       		        yAxisIndex: 1,
	       		        data: data.volumes
	       		    },
	       		    {
		       			name: 'Down',
		       		    type: 'scatter',
		       		    symbol: 'pin',
		       		    data: dataForDown,
		       		    symbolSize:20,
		       		    showEffectOn: 'render',
		       		    rippleEffect: {
		       		    brushType: 'stroke'
		       		},
		       		hoverAnimation: true,
		       			label: {
		       		    	normal: {
		       		        	formatter: '{b}',
		       		            position: 'top',
		       		            color: "black",
		       		            show: true
		       		        }
		       		    },
		       		    itemStyle: {
		       		    	normal: {
		       		        	color: 'blue',
		       		            shadowBlur: 10,
		       		            shadowColor: '#333'
		       		        }
		       		    },
		       		    zlevel: 1
		       		},
			       	{
		       			name: 'Buy',
			       		symbolSize: 20,
			       		data: dataForBuy,
			       		type: 'scatter',
			       		symbol: 'triangle',
			       		itemStyle: {
			       			normal: {
			       		    	color: 'blue',
			       		    }
			       		},
			       	},{
		       	          name: 'MACD',
		       	          type: 'bar',
		       	          xAxisIndex: 2,
		       	          yAxisIndex: 2,
		       	          data: data.macds,
		       	          itemStyle: {
		       		    	  normal: {
		       			          color: function(params) {
		       			              var colorList;
		       			              if (params.data >= 0) {
		       			                  colorList = '#ef232a';
		       			              } else {
		       			                  colorList = '#14b143';
		       			              }
		       			              return colorList;
		       			          },
		       			      }
		       		      }
		       	      },{
		       	          name: 'DIF',
		       	          type: 'line',
		       	          xAxisIndex: 2,
		       	          yAxisIndex: 2,
		       	       	  showSymbol: false,
		       	          data: data.difs
		       	      },{
		       	          name: 'DEA',
		       	          type: 'line',
		       	          xAxisIndex: 2,
		       	          yAxisIndex: 2,
		       	          showSymbol: false,
		       	          data: data.deas
		       	      }]
	       		};
	       		
	       		if (option && typeof option === "object") {
	       		    myChart.setOption(option, true);
	       		}
       	}
       	
       	draw()
    </script>
       		
</html>